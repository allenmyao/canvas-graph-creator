<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../../">
  <title data-ice="title">src/js/util/graph-serialize.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  <a href="test.html" data-ice="testLink">Test</a>
  <a data-ice="repoURL" href="https://github.com/allenmyao/canvas-graph-creator.git" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">js/algorithm</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/algorithm/abstract-algorithm.js~AbstractAlgorithm.html">AbstractAlgorithm</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/algorithm/algorithm-result.js~AlgorithmResult.html">AlgorithmResult</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/algorithm/change.js~Change.html">Change</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/algorithm/step-builder.js~StepBuilder.html">StepBuilder</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/algorithm/step.js~Step.html">Step</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/algorithm/stepper.js~Stepper.html">Stepper</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/algorithm/traversal-algorithm.js~TraversalAlgorithm.html">TraversalAlgorithm</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-InputType">InputType</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-InputType">InputType</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">js/data</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/data/graph.js~Graph.html">Graph</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/data/label.js~Label.html">Label</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">js/data/edge</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/data/edge/dashed-edge.js~DashedEdge.html">DashedEdge</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/data/edge/edge.js~Edge.html">Edge</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/data/edge/solid-edge.js~SolidEdge.html">SolidEdge</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">js/data/node</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/data/node/circle-node.js~CircleNode.html">CircleNode</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/data/node/diamond-node.js~DiamondNode.html">DiamondNode</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/data/node/hexagon-node.js~HexagonNode.html">HexagonNode</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/data/node/node.js~Node.html">Node</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/data/node/octagon-node.js~OctagonNode.html">OctagonNode</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/data/node/pentagon-node.js~PentagonNode.html">PentagonNode</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/data/node/polygon-node.js~PolygonNode.html">PolygonNode</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/data/node/square-node.js~SquareNode.html">SquareNode</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/data/node/triangle-node.js~TriangleNode.html">TriangleNode</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">js/tool</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/tool/algorithm-tool.js~AlgorithmTool.html">AlgorithmTool</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/tool/edge-tool.js~EdgeTool.html">EdgeTool</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/tool/erase-tool.js~EraseTool.html">EraseTool</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/tool/move-tool.js~MoveTool.html">MoveTool</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/tool/node-tool.js~NodeTool.html">NodeTool</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/tool/pan-tool.js~PanTool.html">PanTool</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/tool/select-move-tool.js~SelectMoveTool.html">SelectMoveTool</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/tool/select-tool.js~SelectTool.html">SelectTool</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/tool/tool.js~Tool.html">Tool</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">js/ui</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/ui/canvas.js~Canvas.html">Canvas</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/ui/context-menu.js~ContextMenu.html">ContextMenu</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/ui/dropdown.js~Dropdown.html">Dropdown</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/ui/sidebar-algorithm.js~SidebarAlgorithm.html">SidebarAlgorithm</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/ui/sidebar-content.js~SidebarContent.html">SidebarContent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/ui/sidebar-display.js~SidebarDisplay.html">SidebarDisplay</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/ui/sidebar-select.js~SidebarSelect.html">SidebarSelect</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/ui/sidebar.js~Sidebar.html">Sidebar</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/ui/status-bar.js~StatusBar.html">StatusBar</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/ui/tabs.js~Tabs.html">Tabs</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/ui/toolbar.js~Toolbar.html">Toolbar</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/ui/top-bar.js~TopBar.html">TopBar</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/ui/ui.js~UI.html">UI</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createForm">createForm</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createGraphForm">createGraphForm</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-displayError">displayError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getData">getData</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getInputValue">getInputValue</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getInputValueLocal">getInputValueLocal</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-init">init</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ui">ui</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">js/util</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/util/graph-serialize.js~Serializer.html">Serializer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/util/line-2d.js~Line2D.html">Line2D</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/util/mouse-handler.js~MouseHandler.html">MouseHandler</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/util/point-2d.js~Point2D.html">Point2D</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/util/queue.js~Queue.html">Queue</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/util/stack.js~Stack.html">Stack</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/util/triangle-2d.js~Triangle2D.html">Triangle2D</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/util/vector-2d.js~Vector2D.html">Vector2D</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-bezierDerivative">bezierDerivative</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-calcBezierDistance">calcBezierDistance</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-scrollToElement">scrollToElement</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-Point">Point</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/js/util/graph-serialize.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">const nSerial = require(&apos;node-serialize&apos;);
import { Graph } from &apos;../data/graph&apos;;
import { Node } from &apos;../data/node/node&apos;;
import { Edge } from &apos;../data/edge/edge&apos;;
import { Label } from &apos;../data/label&apos;;

import { CircleNode } from &apos;../data/node/circle-node&apos;;
import { TriangleNode } from &apos;../data/node/triangle-node&apos;;
import { SquareNode } from &apos;../data/node/square-node&apos;;
import { DiamondNode } from &apos;../data/node/diamond-node&apos;;
import { PentagonNode } from &apos;../data/node/pentagon-node&apos;;
import { HexagonNode } from &apos;../data/node/hexagon-node&apos;;
import { OctagonNode } from &apos;../data/node/octagon-node&apos;;

import { SolidEdge } from &apos;../data/edge/solid-edge&apos;;
import { DashedEdge } from &apos;../data/edge/dashed-edge&apos;;

let CIRCULARFLAG = &apos;_$$ND_CC$$_&apos;;
let KEYPATHSEPARATOR = &apos;_$$.$$_&apos;;
let IDTYPE = &apos;_$$TYPE$$_&apos;;
let IDSET = &apos;_$$SET$$_&apos;;
let IDNODE = &apos;_$$NODE$$_&apos;;
let IDEDGE = &apos;_$$EDGE$$_&apos;;
let IDLABEL = &apos;_$$LABEL$$_&apos;;
let IDDATA = &apos;_$$DATA$$_&apos;;

/**
 * Serializer class takes care of saving
 * and loading graph via JSON manipulation
 * @class Serializer
 */
export class Serializer {

  static classesByName = {
    CircleNode: CircleNode,
    TriangleNode: TriangleNode,
    SquareNode: SquareNode,
    DiamondNode: DiamondNode,
    PentagonNode: PentagonNode,
    HexagonNode: HexagonNode,
    OctagonNode: OctagonNode,
    SolidEdge: SolidEdge,
    DashedEdge: DashedEdge,
    Label: Label
  };

  /**
   * Serializer constructor
   * @param {Graph} graph Current graph structure
   * @param {function} resetFn Function to reset graph
   */
  constructor(graph, resetFn) {
    this.currentGraph = graph;
    this.resetFn = resetFn;
    this.quickString = &apos;&apos;;

    if (typeof document !== &apos;undefined&apos;) {
      this.reader = new FileReader();
      this.reader.addEventListener(&apos;load&apos;, (event) =&gt; {
        this.uploadGraph();
      });

      this.uploader = document.getElementById(&apos;graph-uploader&apos;);
      this.uploader.addEventListener(&apos;change&apos;, (event) =&gt; {
        this.reader.readAsText(this.uploader.files[0]);
      });
      this.uploader.addEventListener(&apos;click&apos;, (event) =&gt; {
        this.uploader.value = null;
      });

      this.downloadBtn = document.getElementById(&apos;load-graph-button&apos;);
      this.downloadBtn.addEventListener(&apos;click&apos;, (event) =&gt; {
        this.uploader.click();
      });
      this.downloadBtn = document.getElementById(&apos;save-graph-button&apos;);
      this.downloadBtn.addEventListener(&apos;click&apos;, (event) =&gt; {
        this.downloadGraph();
      });
      this.importBtn = document.getElementById(&apos;import-graph-button&apos;);
      this.importBtn.addEventListener(&apos;click&apos;, (event) =&gt; {
        this.importGraph();
      });
      this.exportBtn = document.getElementById(&apos;export-graph-button&apos;);
      this.exportBtn.addEventListener(&apos;click&apos;, (event) =&gt; {
        this.exportGraph();
      });
    }
  }

   /**
   * Exports element of graph in object form
   * @param {Object} elem The element of graph to be exported
   * @param {Object} cache A remnant of the original serializer
   * @param {string} path A remnant of the original serializer
   * @returns {Object} outputObj Contains the element object data
   */
  exportElement(elem, cache, path) {
    let outputObj = {};
    let key;
    let modKey;
    let setElem;
    let outElem;
    cache[path] = elem;

    for (let name of Object.keys(Serializer.classesByName)) {
      if (elem instanceof Serializer.classesByName[name]) {
        outputObj[IDTYPE] = name;
        break;
      }
    }

    for (key in elem) {
      if (elem.hasOwnProperty(key)) {
        if (typeof elem[key] === &apos;object&apos; &amp;&amp; elem[key] !== null) {
          if (elem[key] instanceof Label) {
            outputObj[IDLABEL + key] = this.exportElement(elem[key], cache, path + KEYPATHSEPARATOR + IDLABEL + key);
          } else if (elem[key] instanceof Node) {
            // Node Field Detected
            outputObj[IDNODE + key] = elem[key].id;
          } else if (elem[key] instanceof Edge) {
            // Edge Field Detected
            outputObj[IDEDGE + key] = elem[key].id;
          } else if (elem[key] instanceof Array || elem[key] instanceof Set) {
            if (elem[key] instanceof Set) {
              modKey = IDSET + key;
            } else {
              modKey = key;
            }
            outputObj[modKey] = [];
            for (setElem of elem[key]) {
              if (setElem instanceof Node) {
                // Node-Array Field Detected
                outElem = IDNODE + setElem.id.toString();
              } else if (setElem instanceof Edge) {
                // Edge-Array Field Detected
                outElem = IDEDGE + setElem.id.toString();
              } else {
                // Primitive-Array Field Detected
                outElem = setElem;
              }
              outputObj[modKey].push(outElem);
            }
          } else {
            outputObj[key] = nSerial.serialize(elem[key], false, outputObj[key], cache, path + KEYPATHSEPARATOR + key);
          }
        } else {
          outputObj[key] = elem[key];
        }
      }
    }
    return outputObj;
  }

  /**
   * Is called when user wants to download the graph
   */
  downloadGraph() {
    let graphStr = JSON.stringify(this.serializeGraph());
    let element = document.createElement(&apos;a&apos;);
    element.setAttribute(&apos;href&apos;, &apos;data:application/json;charset=utf-8,&apos; + encodeURIComponent(graphStr));
    element.setAttribute(&apos;download&apos;, &apos;graphdata.json&apos;);

    element.style.display = &apos;none&apos;;
    document.body.appendChild(element);

    element.click();

    document.body.removeChild(element);
  }

  /**
   * Sets value of textbox to the serialzed graph in JSON form
   */
  exportGraph() {
    let graphStr = JSON.stringify(this.serializeGraph());
    this.quickString = graphStr;
  }

  /**
   * Abstracts graph into outputOBj
   * @returns {Object} outputObj JSON object that can be stringified, contains graph data
   */
  serializeGraph() {
    let obj = this.currentGraph;
    let cache = {};
    let path = &apos;$&apos;;
    let outputObj = {};
    let key;
    let modKey;
    let setElem;
    let outElem;
    cache[path] = obj;

    for (key in obj) {
      if (obj.hasOwnProperty(key)) {
        if (typeof obj[key] === &apos;object&apos; &amp;&amp; obj[key] !== null) {
          if (obj[key] instanceof Set) {
            modKey = IDSET + key;
            outputObj[modKey] = [];
            for (setElem of obj[key]) {
              if (setElem instanceof Node || setElem instanceof Edge) {
                outElem = this.exportElement(setElem, cache,
                    path + KEYPATHSEPARATOR + modKey + KEYPATHSEPARATOR + outputObj[modKey].length.toString());
              } else {
                outElem = nSerial.serialize(setElem, false, outElem, cache,
                    path + KEYPATHSEPARATOR + modKey + KEYPATHSEPARATOR + outputObj[modKey].length.toString());
                // Foreign Set Object
              }
              outputObj[modKey].push(outElem);
            }
          } else {
            outputObj[key] = nSerial.serialize(obj[key], false, outputObj[key], cache, path + KEYPATHSEPARATOR + key);
          }
        } else {
          outputObj[key] = obj[key];
        }
      }
    }
    return outputObj;
  }

  /**
   * Helper function to construct empty objects by class name
   * @param {string} name Name of element type to allocate
   * @returns {Object} outObj The constructed object
   */
  allocateElement(name) {
    let outObj = null;
    // Element allocation of type has type &apos;name&apos;
    if (name.indexOf(&apos;Node&apos;) &gt;= 0) {
      outObj = new Serializer.classesByName[name](0, 0);
    } else if (name.indexOf(&apos;Edge&apos;) &gt;= 0) {
      outObj = new Serializer.classesByName[name](null, null);
    } else if (name.indexOf(&apos;Label&apos;) &gt;= 0) {
      outObj = new Serializer.classesByName[name](0, 0, null);
    }
    return outObj;
  }

  /**
   * Reads the elem contents and converts it to a raw JSON object newElem
   * @param {Object} elem The element of graph to be imported
   * @param {Object} newElem The return element and contains the imported data
   * @param {Object} nodeCache Allows for loading references to existing nodes
   * @param {Object} edgeCache Allows for loading references to existing edges
   * @returns {Object} newElem A fully initialized graph element.
   */
  importElement(elem, newElem, nodeCache, edgeCache) {
    let key;
    let modKey;
    let refKey;
    let arrayElem;
    let addObj;
   // Element found of type &apos;elem[IDTYPE]&apos;
    delete elem[IDTYPE];
    for (key in elem) {
      if (elem.hasOwnProperty(key)) {
        if (key.indexOf(IDLABEL) === 0) {
          modKey = key.substring(IDLABEL.length);
          newElem[modKey] = this.importElement(elem[key], this.allocateElement(elem[key][IDTYPE]), nodeCache, edgeCache);
        } else if (key.indexOf(IDNODE) === 0) {
          modKey = key.substring(IDNODE.length);
          newElem[modKey] = nodeCache[elem[key]];
          // Inner Node found called
        } else if (key.indexOf(IDEDGE) === 0) {
          modKey = key.substring(IDEDGE.length);
          newElem[modKey] = edgeCache[elem[key]];
          // Inner Edge found called
        } else if (elem[key] instanceof Array) {
          if (key.indexOf(IDSET) === 0) {
            // Inner Set found
            modKey = key.substring(IDSET.length);
            newElem[modKey] = new Set();
          } else {
            // Inner Array found
            modKey = key;
            newElem[modKey] = [];
          }
          for (arrayElem of elem[key]) {
            if (typeof arrayElem === &apos;string&apos; || arrayElem instanceof String) {
              if (arrayElem.indexOf(IDNODE) === 0) {
                refKey = Number(arrayElem.substring(IDNODE.length));
                addObj = nodeCache[refKey];
                // Inner-Set Node found
              } else if (arrayElem.indexOf(IDEDGE) === 0) {
                refKey = Number(arrayElem.substring(IDEDGE.length));
                addObj = edgeCache[refKey];
                // Inner-Set Edge found
              } else {
                addObj = nSerial.unserialize(arrayElem, elem);
              }
            } else {
              addObj = nSerial.unserialize(arrayElem, elem);
            }
            if (newElem[modKey] instanceof Set) {
              newElem[modKey].add(addObj);
            } else {
              newElem[modKey].push(addObj);
            }
          }
        } else if (typeof elem[key] === &apos;string&apos; || elem[key] instanceof String) {
          // Inner String found
          if (elem[key].indexOf(CIRCULARFLAG) === 0) {
            throw new Error(&apos;Can\&apos;t deserialize a circular dependency in the top-level graph.&apos;);
          } else {
            newElem[key] = elem[key];
          }
        } else if (key === &apos;isSelected&apos; || key === &apos;showTextCtrl&apos;) {
          // Inner Generic found
          newElem[key] = false;
        } else {
          newElem[key] = nSerial.unserialize(elem[key], elem);
        }
      }
    }
    return newElem;
  }

  /**
   * Will not run if the JSON reader fails. Loads the graph from JSON file
   */
  uploadGraph() {
    let obj;
    let deserializeInfo;
    if (typeof this.reader.result === &apos;undefined&apos; || this.reader.result === &apos;&apos;) {
      return;
    }
    try {
      obj = JSON.parse(this.reader.result);
      deserializeInfo = this.deserializeGraph(obj);
    } catch (ex) {
      // Exception thrown from parser or deserializer. Abort.
      throw ex;
    }
    // Graph Upload OK
    Node.numNodes = deserializeInfo.nodes;
    Edge.numEdges = deserializeInfo.edges;
    this.resetFn(deserializeInfo.graph);
  }

  /**
   * Imports the graph from JSON string
   */
  importGraph() {
    let obj;
    let deserializeInfo;
    if (this.quickString === &apos;&apos;) {
      throw new Error(&apos;Nothing has been saved&apos;);
    }
    try {
      obj = JSON.parse(this.quickString);
      deserializeInfo = this.deserializeGraph(obj);
    } catch (ex) {
      // Exception thrown from parser or deserializer. Abort.
      throw ex;
    }
    // Graph Quickload OK
    Node.numNodes = deserializeInfo.nodes;
    Edge.numEdges = deserializeInfo.edges;
    this.resetFn(deserializeInfo.graph);
  }

  /**
   * Reads the graph data and creates new elements accordingly
   * @param {Object} obj The pre-parsed serial graph data
   * @returns {Object} importResult Data containing the graph and nodes and edge counts
   */
  deserializeGraph(obj) {
    let importResult;
    let newGraph = new Graph();
    let key;
    let modKey;
    let maxNodeID = 0;
    let nodeCache = {};
    let maxEdgeID = 0;
    let edgeCache = {};
    let elem;
    let newElem;
    if (obj === null || obj === {}) {
      // Bad Object
      return null;
    }
    for (key in obj) {
      if (obj.hasOwnProperty(key)) {
        if (key.indexOf(IDSET) === 0 &amp;&amp; obj[key] instanceof Array) {
          modKey = key.substring(IDSET.length);
          // Set found
          newGraph[modKey] = new Set();
          for (elem of obj[key]) {
            if (elem[IDTYPE]) {
              newElem = this.allocateElement(elem[IDTYPE]);
              newElem.id = elem.id;
              newElem[IDDATA] = elem;
              if (newElem instanceof Node) {
               // Cached Node with ID
                nodeCache[newElem.id] = newElem;
                maxNodeID = Math.max(maxNodeID, newElem.id);
              } else if (newElem instanceof Edge) {
                // Cached Edge with ID
                edgeCache[newElem.id] = newElem;
                maxEdgeID = Math.max(maxEdgeID, newElem.id);
              }
            } else {
              newElem = nSerial.unserialize(elem, obj);
            }
            if (newElem !== null) {
              newGraph[modKey].add(newElem);
            }
          }
        } else if (typeof obj[key] === &apos;string&apos; || obj[key] instanceof String) {
          if (obj[key].indexOf(CIRCULARFLAG) === 0) {
            throw new Error(&apos;Can\&apos;t deserialize a circular dependency in the top-level graph.&apos;);
          } else {
            newGraph[key] = obj[key];
          }
        } else {
          newGraph[key] = nSerial.unserialize(obj[key], obj);
        }
      }
    }
    for (key in newGraph) {
      if (newGraph.hasOwnProperty(key)) {
        if (newGraph[key] instanceof Set) {
          // Iterating Set
          for (elem of newGraph[key]) {
            if (elem[IDDATA]) {
              this.importElement(elem[IDDATA], elem, nodeCache, edgeCache);
              delete elem[IDDATA];
            }
          }
        }
      }
    }

    if (!newGraph.validate()) {
      throw new Error(&apos;New Graph failed validation check&apos;);
    }

    importResult = {
      nodes: maxNodeID + 1,
      edges: maxEdgeID + 1,
      graph: newGraph
    };
    return importResult;
  }

  /**
   * Resets the graph
   * @param {Graph} newGraph The graph data to reset with
   */
  resetGraph(newGraph) {
     // Formality, in case it&apos;s triggered by something other than us.
    if (newGraph instanceof Graph) {
      this.currentGraph = newGraph;
    }
  }

}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.6)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
